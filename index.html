<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Send Location to WebSocket</title>
</head>

<body>
  <h1>Send Location to WebSocket</h1>

  <!-- WebSocket URL入力フォーム -->
  <label for="websocketUrlInput">Enter WebSocket URL:</label>
  <input type="text" id="websocketUrlInput" placeholder="Enter WebSocket URL" required>
  <br><br>

  <!-- 送信用デバイスID入力フォーム -->
  <label for="sendDeviceIdInput">Enter Device ID for Sending Location:</label>
  <input type="text" id="sendDeviceIdInput" placeholder="Enter Device ID to Send Location" required>
  <br><br>

  <!-- ボタンとステータス表示 -->
  <button id="startButton" disabled>Start Location Stream</button>
  <button id="stopButton" disabled>Stop Location Stream</button>
  <p id="status">Status: Waiting for action...</p>

  <script>
    var ws;
    var locationInterval;
    var isSendingLocation = false;
    var deviceId = ""; // ランダム生成された登録用デバイスID
    var userDeviceId = ""; // ユーザーが入力する送信対象のデバイスID
    var websocketUrl = ""; // ユーザーが入力するWebSocket URL

    // ランダムなデバイスIDを生成（登録用）
    function generateDeviceId() {
      const randomId = 'device-' + Math.random().toString(36).substr(2, 9);  // ランダムな文字列を生成
      deviceId = randomId;
    }

    // WebSocket接続
    function connectWebSocket() {
      websocketUrl = document.getElementById("websocketUrlInput").value.trim();

      if (websocketUrl === "") {
        alert("Please enter a valid WebSocket URL.");
        return;
      }

      ws = new WebSocket(websocketUrl);

      ws.onopen = () => {
        console.log("WebSocket connected!");
        document.getElementById("status").innerText = "Status: WebSocket connected!";
        updateButtonState(true);

        // WebSocket接続後にデバイスIDを登録
        const registerMessage = JSON.stringify({
          action: "register",
          deviceId: deviceId
        });
        ws.send(registerMessage);
      };

      ws.onmessage = (message) => {
        console.log("Received message: ", message.data);
      };

      ws.onerror = (error) => {
        console.error("WebSocket error: ", error);
        document.getElementById("status").innerText = "Status: WebSocket error.";
      };

      ws.onclose = () => {
        console.log("WebSocket connection closed.");
        document.getElementById("status").innerText = "Status: WebSocket closed.";
        updateButtonState(false);
      };
    }

    // 位置情報を取得してWebSocketで送信
    function sendLocation() {
      if (navigator.geolocation) {
        // 位置情報の取得に成功した場合
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const longitude = position.coords.longitude;
            const latitude = position.coords.latitude;

            console.log(`Location acquired: Longitude: ${longitude}, Latitude: ${latitude}`);

            const payload = {
              action: "sendmessage",
              deviceId: userDeviceId,  // ユーザー入力ID（送信用）を送信
              position: [longitude, latitude],
              sampleTime: new Date().toISOString()
            };

            if (ws && ws.readyState === WebSocket.OPEN) {
              console.log("Sending location:", payload); // 送信する位置情報を表示
              ws.send(JSON.stringify(payload));
              document.getElementById("status").innerText = "Status: Location sent successfully!";
            } else {
              console.log("WebSocket is not open.");
            }
          },
          // エラーハンドリング
          (error) => {
            console.error("Error getting location: ", error);
            document.getElementById("status").innerText = "Status: Error getting location!";
            if (error.code === error.PERMISSION_DENIED) {
              alert("Location permission denied! Please enable location access.");
            } else if (error.code === error.POSITION_UNAVAILABLE) {
              alert("Location information is unavailable. Please try again later.");
            } else if (error.code === error.TIMEOUT) {
              alert("Location request timed out. Please try again.");
            }
          },
          // オプション（位置情報取得にかかる最大時間や精度）
          {
            enableHighAccuracy: true,
            timeout: 10000,  // タイムアウト時間（ミリ秒）
            maximumAge: 0  // 古い位置情報を使用しない
          }
        );
      } else {
        alert("Geolocation is not supported by this browser.");
      }
    }

    function startSendingLocation() {
      locationInterval = setInterval(sendLocation, 1000);  // 1秒ごとに位置情報を送信
      isSendingLocation = true;
      document.getElementById("status").innerText = "Status: Sending location...";
      updateButtonState(true);
    }

    function stopSendingLocation() {
      clearInterval(locationInterval);
      isSendingLocation = false;
      document.getElementById("status").innerText = "Status: Location sending stopped.";
      updateButtonState(false);
    }

    // ボタンの状態更新
    function updateButtonState(isStreaming) {
      if (isStreaming) {
        document.getElementById("startButton").disabled = true;
        document.getElementById("stopButton").disabled = false;
      } else {
        document.getElementById("startButton").disabled = false;
        document.getElementById("stopButton").disabled = true;
      }
    }

    // スタートボタンをクリックしたときに、デバイスIDが入力されているかチェック
    document.getElementById("startButton").addEventListener("click", () => {
      userDeviceId = document.getElementById("sendDeviceIdInput").value.trim();  // ユーザー入力ID（送信用）

      if (userDeviceId === "") {
        alert("Please enter a Device ID for sending location.");
        return;
      }

      // ランダムなデバイスIDを生成（登録用）
      generateDeviceId();

      // デバイスIDが適切かをセキュアに確認
      if (!isValidDeviceId(userDeviceId)) {
        alert("Invalid Device ID. Please enter a valid ID.");
        return;
      }

      connectWebSocket();
      startSendingLocation();
    });

    // ストップボタンをクリックしたとき
    document.getElementById("stopButton").addEventListener("click", () => {
      stopSendingLocation();
    });

    // 入力がある程度進むと、スタートボタンを有効化
    document.getElementById("sendDeviceIdInput").addEventListener("input", () => {
      const sendDeviceIdValue = document.getElementById("sendDeviceIdInput").value.trim();
      if (sendDeviceIdValue !== "") {
        document.getElementById("startButton").disabled = false;
      } else {
        document.getElementById("startButton").disabled = true;
      }
    });

    // デバイスIDの形式を検証する関数
    function isValidDeviceId(deviceId) {
      // ここでデバイスIDの形式を正規表現などで検証できます。
      const deviceIdPattern = /^[a-zA-Z0-9_-]{5,20}$/; // 例: 半角英数字とハイフン、アンダースコアの範囲
      return deviceIdPattern.test(deviceId);
    }
  </script>
</body>

</html>